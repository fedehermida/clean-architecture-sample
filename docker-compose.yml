version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: clean-arch-postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - '${DB_PORT}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
  
  firebase-emulator:
    build:
      context: ./firebase
      dockerfile: Dockerfile
      args:
        - FIREBASE_VERSION=14.23.0
    container_name: clean-arch-firebase-emulator
    stop_grace_period: 1m
    environment:
      FIREBASE_PROJECT: ${FIREBASE_PROJECT}
      GCLOUD_PROJECT: ${FIREBASE_PROJECT}
      FORCE_COLOR: 'true'
      DATA_DIRECTORY: "data"
      CHOKIDAR_USEPOLLING: 'true'
    ports:
      - "4000:4000" # ui
      - "4400:4400" # hub
      - "4600:4600" # logging
      - "5001:5001" # functions
      - "8083:8083" # firestore
      - "8085:8085" # pubsub
      - "9000:9000" # database
      - "9099:9099" # auth
      - "9199:9199" # storage
    volumes:
      - ./firebase/data:/srv/firebase/data:rw
      - ./firebase/cache:/root/.cache:rw
      - ./firebase/.config:/root/.config:rw
      - ./firebase/data/storage:/tmp/firebase/storage:rw
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9099 && nc -z localhost 8083 && nc -z localhost 9000 && nc -z localhost 9199"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mongodb:
    image: mongo:7
    container_name: clean-arch-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    ports:
      - '${MONGO_PORT}:27017'
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: >
        mongosh --quiet
        -u ${MONGO_INITDB_ROOT_USERNAME}
        -p ${MONGO_INITDB_ROOT_PASSWORD}
        --authenticationDatabase admin
        --eval "db.adminCommand('ping')"
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  app:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile.dev}
    container_name: clean-arch-app
    ports:
      - '${PORT}:3000'
      # Node.js debugger port (attach with VSCode or Chrome DevTools)
      - '9229:9229'
    volumes:
      # Mount source code for hot reloading
      - ./src:/app/src
      - ./test:/app/test
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./tsconfig.json:/app/tsconfig.json
      - ./nodemon.json:/app/nodemon.json
      # Exclude node_modules from volume to use container's (preserve installed packages)
      - /app/node_modules
      # Also exclude dist to avoid conflicts
      - /app/dist
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${PORT}
      HTTP_SERVER: ${HTTP_SERVER}
      FRONTEND_URL: ${FRONTEND_URL}
      # PostgreSQL config (host/port are Docker service names)
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # MongoDB config (host/port are Docker service names)
      MONGO_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/${MONGO_DB_NAME}?authSource=admin&directConnection=true
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_DB_NAME: ${MONGO_DB_NAME}
      # Repository type selection: 'inmemory', 'typeorm', 'mongoose', or 'firebase'
      REPOSITORY_TYPE: ${REPOSITORY_TYPE}
      # Auth provider selection: 'inmemory', 'firebase', or 'jwt'
      AUTH_PROVIDER: ${AUTH_PROVIDER:-inmemory}
      JWT_SECRET: ${JWT_SECRET:-clean-architecture-demo-secret}
      # Firebase Emulator config (host/port are Docker service names)
      FIREBASE_PROJECT: ${FIREBASE_PROJECT}
      FIREBASE_AUTH_EMULATOR_HOST: firebase-emulator:9099
      FIRESTORE_EMULATOR_HOST: firebase-emulator:8083
      PUBSUB_EMULATOR_HOST: firebase-emulator:8085
      FUNCTIONS_EMULATOR_HOST: firebase-emulator:5001
      FIREBASE_DATABASE_EMULATOR_HOST: firebase-emulator:9000
      FIREBASE_STORAGE_EMULATOR_HOST: firebase-emulator:9199
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      firebase-emulator:
        condition: service_healthy
    restart: unless-stopped
    # To enable debugging, override the command:
    # docker-compose run --rm -p 3000:3000 -p 9229:9229 app npm run dev:debug

volumes:
  postgres_data:
  mongodb_data:

