openapi: 3.0.3
info:
  title: Clean Architecture API
  description: |
    REST API demonstrating Clean Architecture principles in TypeScript.

    ## Features
    - **User Management**: Register, retrieve, and delete users
    - **Authentication**: Login, logout, and token verification
    - **Product Management**: CRUD operations for products

    ## Architecture Highlights
    This API demonstrates swappable infrastructure:

    ### Repositories (REPOSITORY_TYPE env var)
    - `inmemory` - In-memory storage (default, for testing)
    - `typeorm` - PostgreSQL with TypeORM
    - `mongoose` - MongoDB with Mongoose ODM
    - `firebase` - Firebase Firestore

    ### Authentication Providers (AUTH_PROVIDER env var)
    - `inmemory` - In-memory tokens (default, for testing)
    - `firebase` - Firebase Authentication
    - `jwt` - JWT-based authentication

    ### HTTP Servers (HTTP_SERVER env var)
    - `express` - Express.js (default)
    - `fastify` - Fastify
  version: 1.0.0
  contact:
    name: Clean Architecture Demo
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Local development server

tags:
  - name: Users
    description: User management operations
  - name: Authentication
    description: Authentication operations
  - name: Products
    description: Product management operations
  - name: Health
    description: Health check endpoints

paths:
  /register:
    post:
      tags:
        - Users
      summary: Register a new user
      description: Create a new user account with email and password
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterUserRequest'
            example:
              email: user@example.com
              password: password123
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterUserResponse'
        '400':
          description: Validation error or email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation:
                  value:
                    error: "Invalid email format, Password must be at least 8 characters"
                duplicate:
                  value:
                    error: "Email already in use"

  /users:
    get:
      tags:
        - Users
      summary: Get user by email
      description: Retrieve a user by their email address
      operationId: getUserByEmail
      parameters:
        - name: email
          in: query
          required: true
          schema:
            type: string
            format: email
          example: user@example.com
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Get user by ID
      description: Retrieve a user by their UUID
      operationId: getUserById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found or invalid UUID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
      summary: Delete user
      description: Delete a user by their UUID
      operationId: deleteUser
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User deleted successfully
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate user and receive a token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: Invalidate the current authentication token
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '400':
          description: No token provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get the currently authenticated user's information
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '401':
          description: Not authenticated or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /products:
    get:
      tags:
        - Products
      summary: List all products
      description: Retrieve all products
      operationId: listProducts
      responses:
        '200':
          description: List of products
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductListItem'

    post:
      tags:
        - Products
      summary: Create a product
      description: Create a new product
      operationId: createProduct
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
            example:
              name: Sample Product
              description: A great product
              price: 99.99
              stock: 100
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateProductResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product by ID
      description: Retrieve a product by its UUID
      operationId: getProductById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Product found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Products
      summary: Delete product
      description: Delete a product by its UUID
      operationId: deleteProduct
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Product deleted successfully
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check API health and database connectivity
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnhealthyResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter your auth token

  schemas:
    RegisterUserRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          minLength: 8
          description: Password (minimum 8 characters)

    RegisterUserResponse:
      type: object
      properties:
        userId:
          type: string
          format: uuid
          description: The created user's ID

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthTokenResponse:
      type: object
      properties:
        token:
          type: string
          description: Authentication token
        expiresAt:
          type: string
          format: date-time
          description: Token expiration time

    AuthUserResponse:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email

    CreateProductRequest:
      type: object
      required:
        - name
        - price
        - stock
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Product name
        description:
          type: string
          maxLength: 1000
          description: Product description
          default: ""
        price:
          type: number
          format: float
          minimum: 0.01
          description: Product price (must be positive)
        stock:
          type: integer
          minimum: 0
          description: Available stock quantity

    CreateProductResponse:
      type: object
      properties:
        productId:
          type: string
          format: uuid

    ProductResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        price:
          type: number
          format: float
        stock:
          type: integer
        isInStock:
          type: boolean
          description: Whether the product has available stock
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        price:
          type: number
          format: float
        stock:
          type: integer
        isInStock:
          type: boolean

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
        timestamp:
          type: string
          format: date-time
        database:
          type: string
          example: connected

    UnhealthyResponse:
      type: object
      properties:
        status:
          type: string
          example: unhealthy
        timestamp:
          type: string
          format: date-time
        database:
          type: string
          example: disconnected
        error:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
